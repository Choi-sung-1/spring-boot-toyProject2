<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
</head>
<body>

<h1>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h1>
<a href="/product/list">â† ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ</a>
<p hidden="hidden" id="memberId" th:text="${loginMember.get().memberId}"></p>
<hr>

<!-- ì¥ë°”êµ¬ë‹ˆ ë¹„ì—ˆì„ ë•Œ ë©”ì‹œì§€ -->
<div th:attr="hidden=${!cartList.isEmpty()}" id="emptyCartMessage" style="text-align:center; padding:30px;">
    ğŸ›’ ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.<br>
    ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
</div>

<!-- ì¥ë°”êµ¬ë‹ˆ í…Œì´ë¸” -->
<table border="1" width="100%" cellspacing="0" cellpadding="8" th:if="${!cartList.isEmpty()}" id="cartListTable">
    <thead>
    <tr>
        <th>ìƒí’ˆ ì´ë¯¸ì§€</th>
        <th>ìƒí’ˆëª…</th>
        <th>ê°€ê²©</th>
        <th>ìˆ˜ëŸ‰</th>
        <th>í•©ê³„</th>
        <th>ì‚­ì œ</th>
    </tr>
    </thead>

    <tbody id="tableBody">
    <tr th:each="item:${cartList}" id="tableRow">
        <td>
            <figure>
                <img th:src="@{|/productImages/${item.imageOriginalName}|}" alt="ìƒí’ˆ ì´ë¯¸ì§€" width="100">
                <figcaption th:text="${item.productName}">ìƒí’ˆëª…</figcaption>
            </figure>
        </td>
        <td th:text="${item.productName}">ìƒí’ˆëª…</td>
        <td th:text="${item.formatProductPrice()}">â‚©0</td>
        <td><input type="number" th:value="${item.cartQuantity}" min="1" th:max="${item.productStock}"></td>
        <td th:text="${item.formatTotalPrice()}">â‚©0</td>
        <td><button type="button" class="delBtn">ì‚­ì œ</button></td>
        <td hidden="hidden"><span th:text="${item.cartId}"></span></td>
    </tr>
    </tbody>
</table>

<hr>

<!-- ì´í•© ì˜ì—­ -->
<section>
    <h3>ê²°ì œ ì •ë³´</h3>
    <p id="allProductPrice">ìƒí’ˆ í•©ê³„: â‚©0</p>
    <p>ë°°ì†¡ë¹„: â‚©3,000</p>
    <p><strong id="amount">ì´ ê²°ì œ ê¸ˆì•¡: â‚©3,000</strong></p>
    <button id="paymentBtn" type="button">ê²°ì œí•˜ê¸°</button>
    <button id="rmvCartBtn" type="button">ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°</button>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const emptyCartDiv = document.getElementById("emptyCartMessage");
        const cartTable = document.getElementById("cartListTable");
        const memberId = document.getElementById("memberId").innerText.trim();

        // ì´ˆê¸° ì„¤ì •
        setupQuantityInputs();
        setupDeleteButtons();
        setupClearCartButton();
        updateSummary();

        // ìˆ˜ëŸ‰ ë³€ê²½
        function setupQuantityInputs() {
            document.querySelectorAll("tbody tr").forEach(row => {
                const priceCell = row.querySelector("td:nth-child(3)");
                const qtyInput = row.querySelector("input[type='number']");
                const totalCell = row.querySelector("td:nth-child(5)");

                const price = parseInt(priceCell.textContent.replace(/[^0-9]/g, "")) || 0;

                qtyInput.addEventListener("input", () => {
                    const qty = parseInt(qtyInput.value) || 0;
                    totalCell.textContent = `â‚©${(price * qty).toLocaleString()}`;
                    updateSummary();
                });
            });
        }

        // ê°œë³„ ì‚­ì œ
        function setupDeleteButtons() {
            document.querySelectorAll(".delBtn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const row = btn.closest("tr");
                    handleDeleteItem(row);
                });
            });
        }

        function handleDeleteItem(row) {
            if (!confirm("í•´ë‹¹ ì œí’ˆì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            console.log(row);
            const cartId = row.querySelector("td:nth-child(7) span").innerText.trim();

            fetch(`/order/delete/${cartId}`, { method: "DELETE" })
                .then(res => {
                    if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
                    return res.json();
                })
                .then(() => {
                    row.remove();
                    updateSummary();
                    checkEmptyCart();
                })
                .catch(err => console.error(err));
        }

        // ì „ì²´ ì‚­ì œ
        function setupClearCartButton() {
            document.getElementById("rmvCartBtn").addEventListener("click", () => {
                if (!confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                fetch(`/order/deleteAll/${memberId}`, { method: "DELETE" })
                    .then(res => {
                        if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
                        return res.json();
                    })
                    .then(() => {
                        document.getElementById("tableBody").innerHTML = "";
                        updateSummary();
                        checkEmptyCart();
                    })
                    .catch(err => console.error(err));
            });
        }

        // ì¥ë°”êµ¬ë‹ˆ ë¹„ì—ˆëŠ”ì§€ ì²´í¬
        function checkEmptyCart() {
            const rows = document.querySelectorAll("tbody tr").length;
            if (rows === 0) {
                emptyCartDiv.hidden = false;
                cartTable.hidden = true;
            } else {
                emptyCartDiv.hidden = true;
                cartTable.hidden = false;
            }
        }

        // ì´í•© ê³„ì‚°
        function updateSummary() {
            let sum = 0;
            document.querySelectorAll("tbody tr").forEach(row => {
                const totalCell = row.querySelector("td:nth-child(5)");
                const value = parseInt(totalCell.textContent.replace(/[^0-9]/g, "")) || 0;
                sum += value;
            });
            const delivery = 3000;
            document.getElementById("allProductPrice").textContent = `ìƒí’ˆ í•©ê³„: â‚©${sum.toLocaleString()}`;
            document.getElementById("amount").textContent = `ì´ ê²°ì œ ê¸ˆì•¡: â‚©${(sum + delivery).toLocaleString()}`;
        }
    });
</script>

</html>
