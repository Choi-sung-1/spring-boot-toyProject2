<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
</head>
<body>

<h1>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h1>
<a href="/product/list">â† ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ</a>
<p hidden="hidden" id="memberId" th:text="${loginMember.get().memberId}"></p>
<hr>

<div th:attr="hidden=${!cartList.isEmpty()}" id="emptyCartMessage" style="text-align:center; padding:30px;">
    ğŸ›’ ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.<br>
    ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
</div>

<table border="1" width="100%" cellspacing="0" cellpadding="8" th:if="${!cartList.isEmpty()}" id="cartListTable">
    <thead>
    <tr>
        <th>ìƒí’ˆ ì´ë¯¸ì§€</th>
        <th>ìƒí’ˆëª…</th>
        <th>ê°€ê²©</th>
        <th>ìˆ˜ëŸ‰</th>
        <th>í•©ê³„</th>
        <th>ì‚­ì œ</th>
    </tr>
    </thead>

    <tbody id="tableBody">
    <tr th:each="item:${cartList}" id="tableRow">
        <td>
            <figure>
                <a th:href="@{/product/detail/{productId}(productId=${item.productId})}">
                <img th:src="@{|/productImages/${item.imageOriginalName}|}" alt="ë¬´ì„  ì´ì–´í° V1" width="100">
                </a>
            </figure>
        </td>
        <td id="productName" th:text="${item.productName}">ë¬´ì„  ì´ì–´í° V1</td>
        <td id="productPrice" th:text="|${item.formatProductPrice()}ì›|">â‚©79,000</td>
        <td><input id="productSelect" type="number" th:value="${item.cartQuantity}" min="1" th:max="${item.productStock}"></td>
        <td id="productTotalPrice" th:text="|${item.formatTotalPrice()}ì›|"></td>
        <td><button id="productDelBtn" type="button">ì‚­ì œ</button></td>
        <td hidden="hidden"><input id="cartId" name="cartId" th:text="*{item.cartId}"/></td>
    </tr>
    </tbody>
</table>

<hr>

<!-- ì´í•© ì˜ì—­ -->
<section>
    <h3>ê²°ì œ ì •ë³´</h3>
    <p id="allProductPrice">ìƒí’ˆ í•©ê³„: â‚©149,000</p>
    <a th:href="@{/order/orderPayment}" id="paymentBtn" type="button" onclick="confirmPaymentRedirect(event)">ê²°ì œí•˜ê¸°</a>
    <button id="rmvCartBtn" type="button">ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°</button>
</section>

</body>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const rows = document.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const productPrice = row.querySelector("td:nth-child(3)");
            const productNumber = row.querySelector("input[type='number']");
            const totalPrice = row.querySelector("td:nth-child(5)");
            const delBtn = row.querySelector("td:nth-child(6)");

            const price = parseInt(productPrice.textContent.replace(/[^0-9]/g, ""));

            // ìˆ˜ëŸ‰ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•©ê³„ ê³„ì‚° ì„œë²„ì— ë³´ë‚´ì•¼í•¨ ë³€ê²½ë ë•Œë§ˆë‹¤
            productNumber.addEventListener("change", () => {
                const qty = parseInt(productNumber.value);
                const total = price * qty;
                totalPrice.textContent = `â‚©${total.toLocaleString()}`;
                updateSummary(); // ì´í•©ë„ ë‹¤ì‹œ ê³„ì‚°

                const cartId = row.querySelector("td:nth-child(7)").innerText.trim();

                fetch(`/cart/updateQuantity/${cartId}`, {
                    method:'POST',
                    headers:{
                        'Content-Type': 'application/json'
                    },
                    body:JSON.stringify({cartQuantity:qty})
                }).then(response=>{
                    if (!response.ok){
                        throw new Error('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨');
                    }
                    return response.json();
                }).then(data=>{
                    console.log('ìˆ˜ëŸ‰ ë³€ê²½ ì„±ê³µ',data);
                }).catch(error=>{
                    console.log('ì—ëŸ¬ë°œìƒ',error);
                })
            });

            // ì œí’ˆ í•œê°œ ì‚­ì œ
            delBtn.addEventListener("click",()=>{
                if (!confirm("í•´ë‹¹ ì œí’ˆì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ??")) {
                    return;
                }
                const cartId = row.querySelector("td:nth-child(7)").innerText.trim();
                const emptyCartDiv = document.getElementById('emptyCartMessage');

                fetch(`/cart/delete/${cartId}`, {
                    method: 'DELETE'
                }).then(response=>{
                    if (!response.ok){
                        throw new Error("ì‚­ì œ ì‹¤íŒ¨");
                    }
                    return response.json();
                });
                row.remove();
                updateSummary();
                const carListTable = document.getElementById('cartListTable');
                const remainRows = document.querySelectorAll("tbody tr").length;
                console.log(remainRows);
                if (remainRows===0){
                    emptyCartDiv.hidden = false;
                    carListTable.hidden = true;
                }
            });
        });

        function updateSummary() {
            let sum = 0;

            document.querySelectorAll("tbody tr").forEach(row => {
                const totalCell = row.querySelector("td:nth-child(5)");
                const value = parseInt(totalCell.textContent.replace(/[^0-9]/g, "")) || 0;
                sum += value;
            });
            document.getElementById("allProductPrice").textContent = `ìƒí’ˆ í•©ê³„: â‚©${sum.toLocaleString()}ì›`;
        }
        updateSummary(); // ì´ˆê¸° ë¡œë“œ ì‹œ í•œ ë²ˆ ê³„ì‚°

    });
    // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
    document.getElementById('rmvCartBtn').addEventListener("click",()=>{
        const allTableItem = document.getElementById('cartListTable');
        const emptyCartDiv = document.getElementById('emptyCartMessage');
        const memberId = document.getElementById('memberId').innerText.trim();
        const allProductPrice = document.getElementById('allProductPrice');
        console.log(memberId);
        if(!confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")){
            return;
        }

       fetch(`/cart/deleteAll/${memberId}`,{
           method:'DELETE'
       }).then(response=>{
           if(!response.ok){
               throw new Error("ì‚­ì œ ì‹¤íŒ¨");
           }
           return response.json();
       });
       allTableItem.remove();
       allProductPrice.textContent='ìƒí’ˆ í•©ê³„: â‚©0ì›';
       emptyCartDiv.hidden = false;
    });

    function confirmPaymentRedirect(event) {
        // ê¸°ë³¸ ì´ë™ ë§‰ê¸°
        event.preventDefault();
        if (confirm("ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = "/order/orderPayment";
        }
    }

</script>


</html>
